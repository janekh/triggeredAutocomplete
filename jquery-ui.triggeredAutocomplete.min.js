/********************************************************************************
/*
 * triggeredAutocomplete (jQuery UI autocomplete widget)
 * 2012 by Hawkee.com (hawkee@gmail.com)
 *
 * Version 1.4.5
 *
 * Requires jQuery 1.7 and jQuery UI 1.8
 *
 * Dual licensed under MIT or GPLv2 licenses
 *   http://en.wikipedia.org/wiki/MIT_License
 *   http://en.wikipedia.org/wiki/GNU_General_Public_License
 *
*/
!function(t,e,i,n){t.widget("ui.triggeredAutocomplete",t.extend(!0,{},t.ui.autocomplete.prototype,{options:{trigger:"@",allowDuplicates:!0,maxLength:0},_create:function(){var e=this;this.id_map=new Object,this.stopIndex=-1,this.stopLength=-1,this.contents="",this.cursorPos=0,this.element.bind("keydown.autocomplete.fix",function(i){switch(i.keyCode){case t.ui.keyCode.ESCAPE:e.close(i),i.stopImmediatePropagation();break;case t.ui.keyCode.UP:case t.ui.keyCode.DOWN:e.menu.element.is(":visible")||i.stopImmediatePropagation()}});var i=this.element.attr("id_map");i&&(this.id_map=jQuery.parseJSON(i)),this.ac=t.ui.autocomplete.prototype,this.ac._create.apply(this,arguments),this.updateHidden(),this.options.select=function(t,i){var n=e.contents,s=e.cursorPos,o=n.substring(s,n.length),r=n.substring(0,s);r=r.substring(0,r.lastIndexOf(e.options.trigger));var a=e.element.scrollTop();this.value=r+e.options.trigger+i.item.label+" "+o,e.element.scrollTop(a),e.id_map[i.item.label]=i.item.value,e.updateHidden();var l=r.length+e.options.trigger.length+i.item.label.length+2;if(this.createTextRange){var u=this.createTextRange();u.move("character",l),u.select()}else this.setSelectionRange&&this.setSelectionRange(l,l);return!1},this.options.focus=function(){return!1},this.menu.options.blur=function(){return!1},this.element.focus(function(){e.updateHidden()}),this.element.change(function(){e.updateHidden()})},_renderItem:function(e,i){return i.img!=n?t("<li></li>").data("item.autocomplete",i).append("<a><img src='"+i.img+"' /><span>"+i.label+"</span></a>").appendTo(e):t("<li></li>").data("item.autocomplete",i).append(t("<a></a>").text(i.label)).appendTo(e)},_move:function(t,e){return this.menu.element.is(":visible")?this.menu.first()&&/^previous/.test(t)||this.menu.last()&&/^next/.test(t)?void this.menu.deactivate():void this.menu[t](e):void this.search(null,e)},search:function(){var t=this.element.val(),e=this.getCursor();this.contents=t,this.cursorPos=e;var i=t.substring(t.lastIndexOf(this.options.trigger)-1,e),n=new RegExp("\\B\\"+this.options.trigger+"([\\w\\-]+)");if(t.indexOf(this.options.trigger)>=0&&i.match(n)){t=t.substring(0,e);var s=t.substring(t.lastIndexOf(this.options.trigger)+1,t.length);if(this.stopIndex==t.lastIndexOf(this.options.trigger)&&s.length>this.stopLength&&(s=""),s.length>0&&(!this.options.maxLength||s.length<=this.options.maxLength))return this.updateHidden(),this._search(s);this.close()}},_initSource:function(){var e,i,n=this;t.isArray(this.options.source)?(e=this.options.source,this.source=function(i,n){n(t.ui.autocomplete.filter(e,i.term))}):"string"==typeof this.options.source?(i=this.options.source,this.source=function(e,s){n.xhr&&n.xhr.abort(),n.xhr=t.ajax({url:i,data:e,dataType:"json",success:function(i){null!=i?(s(t.map(i,function(t){return label="string"==typeof t?t:t.label,!n.id_map[label]||n.options.allowDuplicates?t:void 0})),n.stopLength=-1,n.stopIndex=-1):(n.stopLength=e.term.length,n.stopIndex=n.contents.lastIndexOf(n.options.trigger),n.close())}})}):this.source=this.options.source},destroy:function(){t.Widget.prototype.destroy.call(this)},getCursor:function(){var t=this.element[0];if(t.selectionStart)return t.selectionStart;if(t.ownerDocument.selection){var e=t.ownerDocument.selection.createRange();if(!e)return 0;var i=t.createTextRange(),n=i.duplicate();return i.moveToBookmark(e.getBookmark()),n.setEndPoint("EndToStart",i),n.text.length}},updateHidden:function(){var e=this.options.trigger,i=this.element.scrollTop(),n=this.element.val();for(var s in this.id_map){var o=e+s;o=o.replace(/[^a-zA-Z 0-9@]+/g,"\\$&");var r=new RegExp(o,"g"),a=n;n=n.replace(r,e+"["+this.id_map[s]+"]"),a==n&&delete this.id_map[s]}t(this.options.hidden).val(n),this.element.scrollTop(i)}}))}(jQuery,window,document);
