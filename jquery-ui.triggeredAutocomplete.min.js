/********************************************************************************
/*
 * triggeredAutocomplete (jQuery UI autocomplete widget)
 * 2012 by Hawkee.com (hawkee@gmail.com)
 * 2015 by Janek Hiis (janek@weekdone.com)
 *
 * Version 1.5
 *
 * Requires jQuery 1.7 and jQuery UI 1.8
 *
 * Dual licensed under MIT or GPLv2 licenses
 *   http://en.wikipedia.org/wiki/MIT_License
 *   http://en.wikipedia.org/wiki/GNU_General_Public_License
 *
*/
!function(e,t,i,n){e.widget("ui.triggeredAutocomplete",e.extend(!0,{},e.ui.autocomplete.prototype,{options:{trigger:"@",allowDuplicates:!0,maxLength:0},_create:function(){var t=this;this.id_map=new Object,this.stopIndex=-1,this.stopLength=-1,this.contents="",this.cursorPos=0,this.last_index=-1,this.element.bind("keydown.autocomplete.fix",function(i){switch(i.keyCode){case e.ui.keyCode.ESCAPE:t.close(i),i.stopImmediatePropagation();break;case e.ui.keyCode.UP:case e.ui.keyCode.DOWN:t.menu.element.is(":visible")||i.stopImmediatePropagation()}});var i=this.element.attr("id_map");i&&(this.id_map=jQuery.parseJSON(i)),this.ac=e.ui.autocomplete.prototype,this.ac._create.apply(this,arguments),this.updateHidden(),this.options.select=function(e,i){var n=t.contents,s=t.cursorPos,o=n.substring(s,n.length),a=n.substring(0,t.last_index),r=a.slice(-1),l=t.element.scrollTop();this.value=a+i.item.label+" "+o,t.element.scrollTop(l),t.id_map[r+i.item.label]=i.item.value,t.updateHidden();var u=a.length+i.item.label.length+2;if(this.createTextRange){var c=this.createTextRange();c.move("character",u),c.select()}else this.setSelectionRange&&this.setSelectionRange(u,u);return!1},this.options.focus=function(){return!1},this.menu.options.blur=function(){return!1},this.element.focus(function(){t.updateHidden()}),this.element.change(function(){t.updateHidden()})},_renderItem:function(t,i){return i.img!=n?e("<li></li>").data("item.autocomplete",i).append("<a><img src='"+i.img+"' /><span>"+i.label+"</span></a>").appendTo(t):e("<li></li>").data("item.autocomplete",i).append(e("<a></a>").text(i.label)).appendTo(t)},_move:function(e,t){return this.menu.element.is(":visible")?this.menu.first()&&/^previous/.test(e)||this.menu.last()&&/^next/.test(e)?void this.menu.deactivate():void this.menu[e](t):void this.search(null,t)},search:function(){var e=this.element.val(),t=this.getCursor();this.contents=e,this.cursorPos=t;var i=new RegExp("(^|\\s)(["+this.options.trigger+"][\\w-]*)$"),n=i.exec(e.substring(0,t));if(n&&n[2]){var s=n[2];if(this.stopIndex==n.index&&s.length>this.stopLength&&(s=""),s.length>0&&(!this.options.maxLength||s.length<=this.options.maxLength))return this.updateHidden(),this.last_index=n.index+n[1].length+1,this._search(s)}this.close()},_initSource:function(){var t,i,n=this;e.isArray(this.options.source)?(t=this.options.source,this.source=function(i,n){n(e.ui.autocomplete.filter(t,i.term))}):"string"==typeof this.options.source?(i=this.options.source,this.source=function(t,s){n.xhr&&n.xhr.abort(),t.trigger=t.term.substring(0,1),t.term=t.term.substring(1),n.xhr=e.ajax({url:i,data:t,dataType:"json",success:function(i){i.length?(s(e.map(i,function(e){return label="string"==typeof e?e:e.label,!n.id_map[label]||n.options.allowDuplicates?e:void 0})),n.stopLength=-1,n.stopIndex=-1):(n.stopLength=t.term.length,n.stopIndex=n.contents.lastIndexOf(t.term),n.close())}})}):this.source=this.options.source},destroy:function(){e.Widget.prototype.destroy.call(this)},getCursor:function(){var e=this.element[0];if(e.selectionStart)return e.selectionStart;if(e.ownerDocument.selection){var t=e.ownerDocument.selection.createRange();if(!t)return 0;var i=e.createTextRange(),n=i.duplicate();return i.moveToBookmark(t.getBookmark()),n.setEndPoint("EndToStart",i),n.text.length}},updateHidden:function(){var t=this.element.val(),i=this.element.scrollTop();for(var s in this.id_map){var o=t,a=s,r=s.substring(0,1);a=a.replace(/[^a-zA-Z 0-9@]+/g,"\\$&");var l=new RegExp(a,"g");t=t.replace(l,r+"["+this.id_map[s]+"]"),o==t&&delete this.id_map[s]}this.options.hidden!=n&&e(this.options.hidden).val(t),this.element.scrollTop(i)}}))}(jQuery,window,document);
